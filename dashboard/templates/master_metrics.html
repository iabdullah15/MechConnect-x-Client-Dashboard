{# --- Master metrics UI (ONLY: License Keys Overview + Recent Activities) ---
#}
<style>
  :root {
    --mc-primary: #ec6936;
    --mc-gray: #e8e8e8;
    --mc-bg: #f5f5f5;
  }
  body.bg-light {
    background-color: var(--mc-bg) !important;
  }

  /* KPI banner */
  .kpi-banner {
    background: var(--mc-primary);
    color: #fff;
    border-radius: 0.5rem;
    padding: 1.25rem 1.25rem;
  }
  .kpi-banner h1 {
    font-size: 2.75rem;
    margin: 0;
  }

  /* Card look (white) */
  .mc-card.card {
    background: #fff;
  }

  /* Keep Plotly on transparent bg to match cards */
  .plot-card .card-body {
    padding: 1rem 1rem 0.5rem 1rem;
  }
</style>

<div class="kpi-banner mb-4">
  <div
    class="d-flex justify-content-between align-items-center flex-wrap gap-2"
  >
    <div>
      <h4 class="mb-1">Total Chats Initiated</h4>
      <h1 id="total-chats" class="fw-bold mb-0">0</h1>
    </div>
    <div class="text-end">
      <!-- optional secondary info later -->
    </div>
  </div>
</div>

<h3 class="h5 mt-4 mb-3">Authentication &amp; License Key Health</h3>
<div class="row g-3">
  <!-- LEFT: License Keys Overview (Donut) -->
  <div class="col-12 col-lg-6">
    <div class="card mc-card shadow-sm plot-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="h6 mb-0">License Keys Overview</h4>
        </div>
        <div id="license-keys-donut" style="height: 360px"></div>
        <div class="row text-center my-2">
          <div class="col">
            <div class="fw-semibold" id="lk-new">0</div>
            <div class="text-muted small">New License Keys</div>
          </div>
          <div class="col">
            <div class="fw-semibold" id="lk-active">0</div>
            <div class="text-muted small">Active License Keys</div>
          </div>
          <div class="col">
            <div class="fw-semibold" id="lk-inactive">0</div>
            <div class="text-muted small">Inactive License Keys</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Recent Activities -->
  <div class="col-12 col-lg-6">
    <div class="card mc-card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="h6 mb-0">Recent Activities</h4>
        </div>
        <div id="recent-activities">
          <div class="text-muted fst-italic">Loadingâ€¦</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---- Shared palette & base layout ----
  const MC_PRIMARY = "#EC6936";
  const MC_PRIMARY_LIGHT = "#E8E8E8";
  const MC_GRAY = "#E8E8E8";
  const baseLayout = {
    margin: { l: 40, r: 20, t: 20, b: 40 },
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    font: {
      family:
        "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
    },
  };

  function renderLicenseKeysDonut(newVal, activeVal, inactiveVal) {
    const el = document.getElementById("license-keys-donut");
    if (!el) return;

    const labels = [
      "New License Keys",
      "Active License Keys",
      "Inactive License Keys",
    ];
    const values = [newVal, activeVal, inactiveVal];
    const colors = [MC_PRIMARY_LIGHT, MC_PRIMARY, MC_GRAY];
    const total = newVal + activeVal + inactiveVal;

    Plotly.newPlot(
      el,
      [
        {
          type: "pie",
          hole: 0.55,
          labels,
          values,
          marker: { colors },
          textinfo: "label+value",
          textposition: "outside", // ðŸ”¥ move labels outside
          outsidetextfont: { size: 14, color: "#333" }, // bigger + clearer
          hovertemplate: "%{label}: %{value}<extra></extra>",
          sort: false,
        },
      ],
      {
        ...baseLayout,
        height: 360,
        margin: { l: 60, r: 60, t: 40, b: 40 }, // give extra room for outside labels
        showlegend: true,
        annotations: [
          {
            text: total.toString(),
            font: { size: 28, color: "#111", family: "Inter, sans-serif" }, // ðŸ”¥ bigger center number
            showarrow: false,
            x: 0.5,
            y: 0.5,
          },
        ],
      },
      { displayModeBar: false, responsive: true }
    );

    // Update counters
    document.getElementById("lk-new").textContent = newVal;
    document.getElementById("lk-active").textContent = activeVal;
    document.getElementById("lk-inactive").textContent = inactiveVal;
  }

  async function loadLicenseKeysSummary() {
    try {
      const res = await fetch("{% url 'api_license_keys_summary' %}", {
        credentials: "same-origin",
      });
      const j = await res.json();
      if (j.ok && j.data) {
        const { new: n, active: a, inactive: i } = j.data;
        renderLicenseKeysDonut(n, a, i);
      } else {
        renderLicenseKeysDonut(0, 0, 0);
      }
    } catch {
      renderLicenseKeysDonut(0, 0, 0);
    }
  }

  // ----- helpers (from client) -----
  function safe(obj, path, fallback = "") {
    try {
      return (
        path
          .split(".")
          .reduce(
            (o, k) => (o && o[k] !== undefined ? o[k] : undefined),
            obj
          ) ?? fallback
      );
    } catch {
      return fallback;
    }
  }
  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return isNaN(d.getTime()) ? "" : d.toLocaleString();
  }
  function badgeForType(t) {
    t = (t || "").toLowerCase();
    if (t.includes("chat")) return "primary";
    if (t.includes("support")) return "warning";
    if (t.includes("license")) return "success";
    if (t.includes("carpart")) return "info";
    return "secondary";
  }

  // ----- Recent Activities renderer -----
  function renderRecentActivities(list) {
    const wrap = document.getElementById("recent-activities");
    if (!wrap) return;

    const arr = Array.isArray(list) ? list : list?.payload ?? list ?? [];
    wrap.innerHTML = "";
    if (!arr.length) {
      wrap.innerHTML =
        '<div class="text-muted fst-italic">No recent activity.</div>';
      return;
    }
    arr.forEach((item) => {
      const el = document.createElement("div");
      el.className = "activity-item py-2";
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <span class="badge bg-${badgeForType(item.type)} badge-type me-2">${
        item.type || "Activity"
      }</span>
            <span class="fw-semibold">${item.message || ""}</span>
          </div>
          ${
            safe(item, "data.licenseKey.name", "")
              ? `<span class="text-muted small">Key: ${safe(
                  item,
                  "data.licenseKey.name",
                  ""
                )}</span>`
              : ""
          }
        </div>
        <div class="text-muted small mt-1">${formatDate(
          safe(item, "data.createdAt", "") || safe(item, "createdAt", "")
        )}</div>`;
      wrap.appendChild(el);
    });
  }

  // ----- loader for master API -----
  async function loadMasterRecentActivities(limit = 10) {
    try {
      const res = await fetch(
        "{% url 'api_master_recent_activities' %}?limit=" + limit,
        { credentials: "same-origin" }
      );
      const j = await res.json();
      if (j.ok) renderRecentActivities(j.data);
      else renderRecentActivities([]);
    } catch {
      renderRecentActivities([]);
    }
  }

  // Initial loads
  loadLicenseKeysSummary();
  loadMasterRecentActivities(10);
  // setInterval(loadLicenseKeysSummary, 90000);
</script>
